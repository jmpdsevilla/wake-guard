#!/bin/bash

# Wake Guard Configuration Script
# Permite configurar Wake Guard despuÃ©s de la instalaciÃ³n

CONFIG_FILE="$HOME/.wake-guard/config"
WAKEUP_SCRIPT="$HOME/.wakeup"

# Verificar que Wake Guard estÃ© instalado
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "âŒ Error: Wake Guard no estÃ¡ instalado."
    echo "Ejecuta el instalador primero: ./install.sh"
    exit 1
fi

# Leer configuraciÃ³n actual
source "$CONFIG_FILE"

DELAY=${DELAY:-3}
OUTPUT_DIR=${OUTPUT_DIR:-"$HOME/Library/Mobile Documents/com~apple~CloudDocs/WakeGuard"}

echo "ðŸ”§ Wake Guard - ConfiguraciÃ³n"
echo "============================="
echo
echo "ConfiguraciÃ³n actual:"
echo "- Carpeta de destino: $OUTPUT_DIR"
echo "- Delay: $DELAY segundos"
echo

# MenÃº principal
while true; do
    echo "Â¿QuÃ© deseas configurar?"
    echo "1) Cambiar carpeta de destino"
    echo "2) Cambiar delay de captura"
    echo "3) Ver estado del servicio"
    echo "4) Ver logs recientes"
    echo "5) Probar captura manual"
    echo "6) Salir"
    echo
    read -p "Selecciona opciÃ³n [6]: " OPTION
    OPTION=${OPTION:-6}
    
    case $OPTION in
        1)
            echo
            echo "ðŸ“ Configurar carpeta de destino"
            echo "1) iCloud Drive"
            echo "2) Escritorio"
            echo "3) Documentos"
            echo "4) Carpeta personalizada"
            echo "5) Mantener actual"
            echo
            read -p "Selecciona opciÃ³n [5]: " FOLDER_OPTION
            FOLDER_OPTION=${FOLDER_OPTION:-5}

            case $FOLDER_OPTION in
                1)
                    NEW_OUTPUT_DIR="$HOME/Library/Mobile Documents/com~apple~CloudDocs/WakeGuard"
                    ;;
                2)
                    NEW_OUTPUT_DIR="$HOME/Desktop/WakeGuard"
                    ;;
                3)
                    NEW_OUTPUT_DIR="$HOME/Documents/WakeGuard"
                    ;;
                4)
                    read -p "Introduce la ruta completa: " CUSTOM_PATH
                    if [[ -z "$CUSTOM_PATH" ]]; then
                        echo "âŒ Ruta vacÃ­a, manteniendo configuraciÃ³n actual"
                        NEW_OUTPUT_DIR="$OUTPUT_DIR"
                    else
                        NEW_OUTPUT_DIR="${CUSTOM_PATH}/WakeGuard"
                    fi
                    ;;
                5)
                    NEW_OUTPUT_DIR="$OUTPUT_DIR"
                    ;;
                *)
                    NEW_OUTPUT_DIR="$OUTPUT_DIR"
                    ;;
            esac
            
            OUTPUT_DIR="$NEW_OUTPUT_DIR"
            mkdir -p "$OUTPUT_DIR"
            echo "âœ… Carpeta actualizada: $OUTPUT_DIR"
            ;;
            
        2)
            echo
            read -p "Nuevo delay antes de tomar foto (segundos) [$DELAY]: " NEW_DELAY
            if [[ "$NEW_DELAY" =~ ^[0-9]+$ ]] && [[ "$NEW_DELAY" -ge 0 ]]; then
                DELAY=$NEW_DELAY
                echo "âœ… Delay actualizado: $DELAY segundos"
            else
                echo "âŒ Valor invÃ¡lido, manteniendo delay actual: $DELAY segundos"
            fi
            ;;
            
        3)
            echo
            echo "ðŸ“Š Estado del servicio"
            echo "====================="
            LAUNCH_AGENT="$HOME/Library/LaunchAgents/de.bernhard-baehr.sleepwatcher-20compatibility-localuser.plist"
            if [[ -f "$LAUNCH_AGENT" ]]; then
                if launchctl list | grep -q "sleepwatcher"; then
                    echo "âœ… SleepWatcher estÃ¡ ejecutÃ¡ndose"
                else
                    echo "âš ï¸  SleepWatcher no estÃ¡ ejecutÃ¡ndose"
                    echo "Intenta: launchctl load '$LAUNCH_AGENT'"
                fi
            else
                echo "âŒ LaunchAgent no encontrado"
            fi
            
            if [[ -f "$WAKEUP_SCRIPT" ]]; then
                echo "âœ… Script wakeup existe"
            else
                echo "âŒ Script wakeup no encontrado"
            fi
            
            if command -v imagesnap &> /dev/null; then
                echo "âœ… ImageSnap instalado"
            else
                echo "âŒ ImageSnap no encontrado"
            fi
            ;;
            
        4)
            echo
            echo "ðŸ“‹ Logs recientes (Ãºltimas 20 lÃ­neas)"
            echo "====================================="
            LOG_FILE="$HOME/Library/Logs/wake-guard.log"
            if [[ -f "$LOG_FILE" ]]; then
                tail -20 "$LOG_FILE"
            else
                echo "No hay logs disponibles"
            fi
            ;;
            
        5)
            echo
            echo "ðŸ“¸ Probando captura manual..."
            PHOTO_NAME="test_$(date +'%Y-%m-%d_%H-%M-%S').jpg"
            if imagesnap -q "$OUTPUT_DIR/$PHOTO_NAME"; then
                echo "âœ… Foto de prueba capturada: $PHOTO_NAME"
                echo "ðŸ“ UbicaciÃ³n: $OUTPUT_DIR"
            else
                echo "âŒ Error capturando foto de prueba"
                echo "Verifica los permisos de cÃ¡mara en ConfiguraciÃ³n del Sistema"
            fi
            ;;
            
        6)
            break
            ;;
            
        *)
            echo "âŒ OpciÃ³n invÃ¡lida"
            ;;
    esac
    
    echo
done

# Guardar configuraciÃ³n actualizada
cat > "$CONFIG_FILE" << EOF
# Wake Guard Configuration
OUTPUT_DIR="$OUTPUT_DIR"
DELAY=$DELAY
EOF

echo "âœ… ConfiguraciÃ³n guardada:"
echo "- Carpeta de destino: $OUTPUT_DIR"
echo "- Delay: $DELAY segundos"
echo
echo "Los cambios se aplicarÃ¡n en el prÃ³ximo despertar del Mac."